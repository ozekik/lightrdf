# This file is autogenerated by maturin v1.2.3
# To update, run
#
#    maturin generate-ci github
#
name: CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # https://srz-zumix.blogspot.com/2019/10/github-actions-ci-skip.html
  prepare:
    runs-on: ubuntu-latest
    if: "! contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - run: echo "[skip ci] ${{ contains(github.event.head_commit.message, '[skip ci]') }}"

  lint:
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install latest stable
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt

      - name: Lint with rustfmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt

      # - name: Lint with clippy
      #   uses: actions-rs/cargo@v1
      #   with:
      #     command: clippy
      #     args: --all-targets --all-features

      # - name: Test with cargo
      #   uses: actions-rs/cargo@v1.0.1
      #   with:
      #     command: test
      #     toolchain: nightly

  linux:
    runs-on: ubuntu-latest
    needs: [prepare]
    strategy:
      matrix:
        # target: [x86_64, x86, aarch64, armv7, s390x, ppc64le]
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
          manylinux: auto
      - name: Run tests
        # NOTE: aarch64 is built on docker, so we cannot run tests on it
        if: "matrix.target != 'aarch64'"
        shell: bash
        # TODO: Run on all Python versions
        run: |
          python3.10 -m pip install --upgrade pip
          python3.10 -m pip install pytest~=7.4.2
          python3.10 -m pip install dist/*cp310*${{ matrix.wheel_arch || matrix.target }}*.whl
          cd tests/
          python3.10 -m pytest .
      - name: Upload wheels
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: dist

  windows:
    runs-on: windows-latest
    needs: [prepare]
    strategy:
      matrix:
        # target: [x64, x86]
        target: [x64]
        include:
          - target: x64
            wheel_arch: amd64
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: ${{ matrix.target }}
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
      - name: Run tests
        shell: bash
        # TODO: Run on all Python versions
        # NOTE: There is no versioned Python executables on Windows
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest~=7.4.2
          python -m pip install dist/*cp310*${{ matrix.wheel_arch || matrix.target }}*.whl
          cd tests/
          python -m pytest .
      - name: Upload wheels
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: dist

  macos:
    runs-on: macos-latest
    needs: [prepare]
    strategy:
      matrix:
        target: [x86_64, aarch64]
        include:
          - target: aarch64
            wheel_arch: arm64
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --find-interpreter
          sccache: 'true'
      - name: Run tests
        # NOTE: We cannnot run tests for aarch64 (arm64)
        if: "matrix.target != 'aarch64'"
        shell: bash
        # TODO: Run on all Python versions
        run: |
          python3.10 -m pip install --upgrade pip
          python3.10 -m pip install pytest~=7.4.2
          python3.10 -m pip install dist/*cp310*${{ matrix.wheel_arch || matrix.target }}*.whl
          cd tests/
          python3.10 -m pytest .
      - name: Upload wheels
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: dist

  sdist:
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout@v3
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: dist

  release:
    name: Release
    runs-on: ubuntu-latest
    if: "startsWith(github.ref, 'refs/tags/')"
    needs: [linux, windows, macos, sdist]
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: wheels
      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI }}
        with:
          command: upload
          args: --non-interactive --skip-existing *
